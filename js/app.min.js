(()=>{'use strict';
const d=document,$=(s,r=d)=>r.querySelector(s),$$=(s,r=d)=>Array.from(r.querySelectorAll(s));
const rm=!!(window.matchMedia&&matchMedia('(prefers-reduced-motion: reduce)').matches);
const ROUTES=['home','request','results','inbox'];
const DB_KEY='mock_db_requests_v1';
const UI_KEY='mock_ui_state_v1';
const UI_DEF={theme:'dark',lastRoute:'home',lastSelected:null};

const INLINE_MECHANICS=[
  {id:'kells-001',name:'Kells Mobile Mechanic',area:'Kells',county:'Meath',phones:['089 219 3220','089 499 3928'],hours:{days:[1,2,3,4,5],open:'10:30',close:'16:30'},services:['engine','diagnostics','brakes','electrical','suspension','tyres'],rating:4.8,jobs:128,responseMins:22,travelKm:35},
  {id:'dublin-001',name:'Dublin City Garage',area:'Dublin',county:'Dublin',phones:['01 555 0199'],hours:{days:[1,2,3,4,5,6],open:'08:30',close:'18:00'},services:['diagnostics','brakes','service','tyres','clutch'],rating:4.6,jobs:540,responseMins:35,travelKm:18},
  {id:'drogheda-001',name:'Drogheda Auto Assist',area:'Drogheda',county:'Louth',phones:['041 555 0201'],hours:{days:[1,2,3,4,5],open:'09:00',close:'17:00'},services:['engine','electrical','diagnostics','service'],rating:4.7,jobs:312,responseMins:28,travelKm:22},
  {id:'navan-001',name:'Navan Workshop',area:'Navan',county:'Meath',phones:['046 555 0118'],hours:{days:[1,2,3,4,5],open:'09:00',close:'17:30'},services:['brakes','suspension','tyres','service'],rating:4.5,jobs:220,responseMins:45,travelKm:28}
];

let ui=loadUI(),requests=loadRequests(),mechanics=INLINE_MECHANICS.slice();
let activeDlg=null,lastFocus=null,toastTimer=null,lastMatch={requestId:null,mechanics:[]};

/* ---------- Storage ---------- */
function loadUI(){try{const raw=localStorage.getItem(UI_KEY);return raw?{...UI_DEF,...JSON.parse(raw)}:{...UI_DEF};}catch{return{...UI_DEF};}}
function saveUI(){try{localStorage.setItem(UI_KEY,JSON.stringify({theme:ui.theme,lastRoute:ui.lastRoute,lastSelected:ui.lastSelected}));}catch{}}
function loadRequests(){try{const raw=localStorage.getItem(DB_KEY);const arr=raw?JSON.parse(raw):[];return Array.isArray(arr)?arr:[];}catch{return[];}}
function saveRequests(){try{localStorage.setItem(DB_KEY,JSON.stringify(requests));}catch{}}

/* ---------- Theme ---------- */
function setTheme(t){t=t==='light'?'light':'dark';ui.theme=t;d.documentElement.setAttribute('data-theme',t);saveUI();}
function toggleTheme(){setTheme(ui.theme==='dark'?'light':'dark');toast(ui.theme==='dark'?'Dark mode':'Light mode');}

/* ---------- Router ---------- */
function getRoute(){const h=(location.hash||'#home').slice(1).trim();return ROUTES.includes(h)?h:'home';}
function navigate(r){location.hash='#'+(ROUTES.includes(r)?r:'home');}
function showRoute(route){
  $$('[data-view]').forEach(v=>{const on=v.dataset.view===route;v.hidden=!on;v.setAttribute('aria-hidden',String(!on));});
  $$('[data-route]').forEach(a=>{const on=a.dataset.route===route||a.getAttribute('href')===`#${route}`;on?(a.setAttribute('aria-current','page'),a.classList.add('is-active')):(a.removeAttribute('aria-current'),a.classList.remove('is-active'));});
  ui.lastRoute=route;saveUI();
  if(route==='results')renderResultsFromLast();
  if(route==='inbox')renderInbox();
  if(route==='request')resetStepper();
  const v=$(`[data-view="${route}"]`);
  if(v){
    const f=v.querySelector('[data-focus],h1,h2,[tabindex="-1"]');
    if(f){f.setAttribute('tabindex','-1');rm?f.focus({preventScroll:false}):setTimeout(()=>f.focus({preventScroll:false}),0);}
  }
}

/* ---------- Mock data loader (offline-safe) ---------- */
async function tryLoadMechanics(){
  for(const url of ['assets/mock/mechanics.json','assets/mechanics.json']){
    try{
      const res=await fetch(url,{cache:'no-store'});
      if(!res.ok)continue;
      const data=await res.json();
      const list=Array.isArray(data)?data:(data&&Array.isArray(data.mechanics)?data.mechanics:null);
      if(list&&list.length){mechanics=list;return;}
    }catch{}
  }
}

/* ---------- Toast ---------- */
function toastEl(){return $('[data-component="toast"]')||$('.toast');}
function toast(msg){
  const el=toastEl();if(!el)return;
  const t=el.querySelector('[data-bind="toastText"],.toast__text')||el;
  t.textContent=String(msg||'');
  el.hidden=false;
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>{el.hidden=true;},rm?2200:3200);
}
function dismissToast(){const el=toastEl();if(el)el.hidden=true;}

/* ---------- Dialog + focus trap ---------- */
function overlay(){return $('[data-component="overlay"]')||$('.overlay');}
function dlg(name){return $(`[data-dialog="${name}"]`)||$(`#${name}`);}
function focusables(root){
  const sel='a[href],button:not([disabled]),input:not([disabled]),select:not([disabled]),textarea:not([disabled]),[tabindex]:not([tabindex="-1"])';
  return $$(sel,root).filter(el=>!el.hidden&&el.offsetParent!==null);
}
function trap(e){
  if(!activeDlg||e.key!=='Tab')return;
  const f=focusables(activeDlg);if(!f.length)return;
  const first=f[0],last=f[f.length-1];
  if(e.shiftKey&&d.activeElement===first){e.preventDefault();last.focus();}
  else if(!e.shiftKey&&d.activeElement===last){e.preventDefault();first.focus();}
}
function ensureRequestDlg(){
  let x=dlg('request-detail');if(x)return x;
  x=d.createElement('section');
  x.className='dialog';
  x.hidden=true;
  x.setAttribute('role','dialog');
  x.setAttribute('aria-modal','true');
  x.setAttribute('aria-labelledby','requestDetailTitle');
  x.setAttribute('data-dialog','request-detail');
  x.innerHTML=`<header class="dialog__header"><h2 id="requestDetailTitle">Request details</h2><button class="icon-button" type="button" data-action="close-dialog" data-dialog="request-detail" aria-label="Close dialog">×</button></header><div class="dialog__body"><div data-bind="requestDetail"></div><div class="dialog__actions" role="group" aria-label="Request actions"><button class="button" type="button" data-action="copy-request">Copy request</button><button class="button button--primary" type="button" data-action="close-dialog" data-dialog="request-detail">Done</button></div></div>`;
  d.body.appendChild(x);
  return x;
}
function openDialog(name,trigger){
  const x=name==='request-detail'?ensureRequestDlg():dlg(name);
  if(!x)return;
  const ov=overlay();if(ov)ov.hidden=false;
  lastFocus=trigger||d.activeElement;
  activeDlg=x;
  x.hidden=false;
  const f=focusables(x);
  (f[0]||x).focus({preventScroll:true});
}
function closeDialog(name){
  const x=name?(name==='request-detail'?ensureRequestDlg():dlg(name)):activeDlg;
  if(!x)return;
  x.hidden=true;
  if(activeDlg===x)activeDlg=null;
  const ov=overlay();if(ov)ov.hidden=true;
  if(lastFocus&&lastFocus.focus)lastFocus.focus({preventScroll:true});
}

/* ---------- Clipboard (file:// safe) ---------- */
async function copyText(text){
  const v=String(text||'').trim();if(!v)return false;
  try{if(navigator.clipboard&&navigator.clipboard.writeText){await navigator.clipboard.writeText(v);return true;}}catch{}
  try{
    const ta=d.createElement('textarea');
    ta.value=v;ta.readOnly=true;
    ta.style.position='fixed';ta.style.left='-9999px';
    d.body.appendChild(ta);
    ta.select();
    const ok=d.execCommand&&d.execCommand('copy');
    d.body.removeChild(ta);
    return !!ok;
  }catch{return false;}
}

/* ---------- Form + validation + stepper ---------- */
const stepper={form:null,steps:[],i:0};
function reqForm(){
  return $('[data-component="request-form"]')||$('#requestForm')||$('form[data-action="submit-request"]')||$('[data-view="request"] form');
}
function errRegion(form){return form?(form.querySelector('[data-component="form-errors"]')||$('#formErrors')):null;}
function ensureErr(form){
  let r=errRegion(form);
  if(r)return r;
  r=d.createElement('div');
  r.className='form-errors';
  r.setAttribute('role','alert');
  r.setAttribute('aria-live','assertive');
  r.hidden=true;
  form.prepend(r);
  return r;
}
function clearErrs(form){
  if(!form)return;
  const r=errRegion(form);
  if(r){r.textContent='';r.hidden=true;}
  $$('[aria-invalid="true"]',form).forEach(el=>el.removeAttribute('aria-invalid'));
  $$('[data-error-for]',form).forEach(el=>{el.textContent='';el.hidden=true;});
}
function escSel(v){return (window.CSS&&CSS.escape)?CSS.escape(v):String(v).replace(/[^a-zA-Z0-9_-]/g,'_');}
function fKey(f){return f.name||f.id||'';}
function ensureFieldErr(form,f){
  const k=fKey(f);if(!k)return null;
  let el=form.querySelector(`[data-error-for="${escSel(k)}"]`);
  if(!el&&f.id)el=$(`#${escSel(f.id)}-error`,form);
  if(!el){
    el=d.createElement('div');
    el.className='field-error';
    el.hidden=true;
    el.setAttribute('data-error-for',k);
    el.setAttribute('role','alert');
    if(f.id)el.id=`${f.id}-error`;
    f.insertAdjacentElement('afterend',el);
  }
  return el;
}
function mergeDesc(f,id){
  const cur=(f.getAttribute('aria-describedby')||'').split(/\s+/).filter(Boolean);
  if(id&&!cur.includes(id))cur.push(id);
  return cur.join(' ');
}
function setFieldErr(form,f,msg){
  f.setAttribute('aria-invalid','true');
  const el=ensureFieldErr(form,f);
  if(el){
    el.textContent=msg;
    el.hidden=false;
    if(el.id)f.setAttribute('aria-describedby',mergeDesc(f,el.id));
  }
}
function normPhone(v){return String(v||'').replace(/[^0-9+]/g,'');}
function validateField(f){
  if(!f||f.disabled)return null;
  const req=f.required||f.getAttribute('aria-required')==='true'||f.dataset.required==='true';
  const val=(f.value||'').trim();
  if(req&&!val)return 'This field is required.';
  const key=fKey(f).toLowerCase(),type=(f.type||'').toLowerCase();
  if((type==='tel'||key.includes('phone'))&&val){
    const digits=normPhone(val).replace(/\D/g,'');
    if(digits.length<7)return 'Enter a valid phone number.';
  }
  if(type==='number'&&val){
    const n=Number(val);
    if(!Number.isFinite(n))return 'Enter a valid number.';
  }
  return null;
}
function validateSection(form,root){
  const fields=$$('input,select,textarea',root).filter(f=>f.offsetParent!==null&&!f.closest('[hidden]'));
  const errs=[];
  fields.forEach(f=>{
    const msg=validateField(f);
    if(msg){errs.push({f,msg});setFieldErr(form,f,msg);}
  });
  return errs;
}
function initStepper(){
  const form=reqForm();if(!form)return;
  stepper.form=form;
  stepper.steps=$$('[data-step]',form).sort((a,b)=>Number(a.dataset.step||0)-Number(b.dataset.step||0));
  stepper.i=0;
  if(stepper.steps.length)showStep(0);
}
function showStep(i){
  if(!stepper.steps.length)return;
  stepper.i=Math.max(0,Math.min(i,stepper.steps.length-1));
  stepper.steps.forEach((s,idx)=>{s.hidden=idx!==stepper.i;s.setAttribute('aria-hidden',String(idx!==stepper.i));});
  const p=$('[data-bind="stepProgress"]');
  if(p)p.textContent=`${stepper.i+1}/${stepper.steps.length}`;
}
function resetStepper(){if(!stepper.steps.length)return;clearErrs(stepper.form);showStep(0);}
function stepNext(){
  if(!stepper.form||!stepper.steps.length)return;
  clearErrs(stepper.form);
  const reg=ensureErr(stepper.form),cur=stepper.steps[stepper.i],errs=validateSection(stepper.form,cur);
  if(errs.length){
    reg.hidden=false;
    reg.textContent=`Please fix ${errs.length} field${errs.length===1?'':'s'} to continue.`;
    errs[0].f.focus({preventScroll:false});
    return;
  }
  showStep(stepper.i+1);
}
function stepBack(){if(stepper.steps.length)showStep(stepper.i-1);}
function collectReq(form){
  const fd=new FormData(form);
  const loc={county:String(fd.get('county')||fd.get('location')||fd.get('area')||'').trim(),city:String(fd.get('city')||fd.get('town')||'').trim()};
  const car={make:String(fd.get('make')||'').trim(),model:String(fd.get('model')||'').trim(),year:String(fd.get('year')||'').trim()};
  return {
    id:`r-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,6)}`,
    createdAt:new Date().toISOString(),
    location:loc,
    car:car,
    category:String(fd.get('category')||fd.get('issueCategory')||'').trim(),
    description:String(fd.get('description')||fd.get('issue')||fd.get('problem')||'').trim(),
    urgency:String(fd.get('urgency')||'standard').trim(),
    phone:String(fd.get('phone')||fd.get('phoneNumber')||'').trim(),
    contact:String(fd.get('contact')||fd.get('contactPreference')||'call').trim(),
    raw:Object.fromEntries(fd.entries())
  };
}

/* ---------- Matching ---------- */
const nrm=s=>String(s||'').toLowerCase().trim();
function t2m(h){const m=String(h||'').match(/^(\d{1,2}):(\d{2})$/);return m?Number(m[1])*60+Number(m[2]):null;}
function isOpen(mech,now=new Date()){
  const h=mech.hours;
  if(!h||!Array.isArray(h.days))return false;
  const day=now.getDay();
  if(!h.days.includes(day))return false;
  const o=t2m(h.open),c=t2m(h.close);
  if(o==null||c==null)return false;
  const cur=now.getHours()*60+now.getMinutes();
  return cur>=o&&cur<=c;
}
function score(mech,req){
  let s=0;
  const county=nrm(req.location.county),city=nrm(req.location.city),mc=nrm(mech.county),ma=nrm(mech.area);
  if(county&&mc&&county===mc)s+=60;
  else if(county&&mc&&mc.includes(county))s+=35;
  if(city&&ma&&(city===ma||ma.includes(city)||city.includes(ma)))s+=25;
  const cat=nrm(req.category),desc=nrm(req.description),svc=Array.isArray(mech.services)?mech.services.map(nrm):[];
  if(cat&&svc.includes(cat))s+=35;
  for(const x of [{k:'brake',s:'brakes'},{k:'battery',s:'electrical'},{k:'start',s:'electrical'},{k:'engine',s:'engine'},{k:'oil',s:'engine'},{k:'noise',s:'diagnostics'},{k:'tyre',s:'tyres'},{k:'suspension',s:'suspension'},{k:'clutch',s:'clutch'}]){
    if((cat&&cat.includes(x.k))||(desc&&desc.includes(x.k))){
      if(svc.includes(x.s))s+=10;
    }
  }
  s+=isOpen(mech)?12:-4;
  const r=Number(mech.rating||0);if(r)s+=Math.round(r*2);
  const j=Number(mech.jobs||0);if(j)s+=Math.min(12,Math.floor(j/60));
  return s;
}
function match(req){
  const list=(mechanics||[]).map(m=>({m,sc:score(m,req)}));
  list.sort((a,b)=>b.sc-a.sc);
  return list.map(x=>x.m);
}

/* ---------- Render results ---------- */
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');}
function resHost(){return $('[data-component="results-list"]')||$('#resultsList')||$('[data-bind="resultsList"]');}
function inboxHost(){return $('[data-component="inbox-list"]')||$('#inboxList')||$('[data-bind="inboxList"]');}
function tel(p){return String(p||'').replace(/[^0-9+]/g,'');}
function t12(h){
  const m=String(h||'').match(/^(\d{1,2}):(\d{2})$/);
  if(!m)return '';
  let hh=Number(m[1]);const mm=m[2],ap=hh>=12?'pm':'am';
  hh=hh%12;if(hh===0)hh=12;
  return `${hh}:${mm}${ap}`;
}
function fmtHours(mech){
  const h=mech.hours;
  if(!h)return '';
  const wd=Array.isArray(h.days)&&[1,2,3,4,5].every(x=>h.days.includes(x))&&h.days.length===5;
  const label=wd?'Weekdays only':'Hours';
  const o=t12(h.open),c=t12(h.close);
  return [label,(o&&c?`${o}–${c}`:'')].filter(Boolean).join(' ');
}
function card(m){
  const open=isOpen(m);
  const phones=Array.isArray(m.phones)?m.phones:[];
  const btns=phones.map(p=>`<div class="contact__actions"><a class="button button--primary" href="tel:${tel(p)}" aria-label="Call ${esc(m.name)} at ${esc(p)}">Call now</a><button class="button button--secondary" type="button" data-action="copy-number" data-number="${esc(p)}">Copy number</button></div>`).join('');
  const metrics=`<dl class="metrics" aria-label="Mechanic metrics"><div><dt>Rating</dt><dd>${esc(String(m.rating||'—'))}</dd></div><div><dt>Jobs</dt><dd>${esc(String(m.jobs||'—'))}</dd></div></dl>`;
  return `<article class="matched-mechanic card--match" data-entity="mechanic" data-mechanic-id="${esc(m.id)}"><div class="matched-mechanic__top"><div><h2 class="matched-mechanic__name">${esc(m.name)}</h2><p class="matched-mechanic__area">${esc(m.area)}${m.county?`, Co. ${esc(m.county)}`:''}</p><p class="matched-mechanic__hours">${esc(fmtHours(m))}</p><p class="hint">${open?'Open now':'Closed now'} • Response ~${esc(String(m.responseMins||'—'))} mins • Travel ${esc(String(m.travelKm||'—'))} km</p></div>${metrics}</div><div class="matched-mechanic__services" aria-label="Services">${(Array.isArray(m.services)?m.services.slice(0,6):[]).map(s=>`<span class="pill">${esc(s)}</span>`).join('')}</div><div class="matched-mechanic__contact">${btns}</div></article>`;
}
function renderResults(list){
  const host=resHost();if(!host)return;
  host.innerHTML='';
  const empty=$('[data-state="results-empty"]')||$('[data-state="match-empty"]');
  if(!list||!list.length){if(empty)empty.hidden=false;toast('No matches found');return;}
  if(empty)empty.hidden=true;
  host.insertAdjacentHTML('beforeend',list.slice(0,3).map(card).join(''));
  toast('Matched mechanics ready');
}
function renderResultsFromLast(){if(lastMatch.requestId)renderResults(lastMatch.mechanics);}

/* ---------- Inbox / admin ---------- */
function rel(iso){
  const t=Date.parse(iso||'');if(!Number.isFinite(t))return '';
  const m=Math.floor((Date.now()-t)/60000);
  if(m<1)return 'now';
  if(m<60)return `${m}m`;
  const h=Math.floor(m/60);
  if(h<24)return `${h}h`;
  return `${Math.floor(h/24)}d`;
}
function renderInbox(){
  const host=inboxHost();if(!host)return;
  host.innerHTML='';
  const list=Array.isArray(requests)?requests.slice().reverse():[];
  const empty=$('[data-state="inbox-empty"]');
  if(empty)empty.hidden=!!list.length;
  if(!list.length)return;
  host.insertAdjacentHTML('beforeend',list.slice(0,50).map(r=>{
    const title=`${r.location.county||'Ireland'} • ${r.category||'Request'}`;
    const when=rel(r.createdAt);
    const prev=(r.description||'').slice(0,90);
    return `<li class="thread" data-entity="request" data-request-id="${esc(r.id)}"><button class="thread__button" type="button" data-action="open-request" data-request-id="${esc(r.id)}"><span class="avatar" aria-hidden="true">RQ</span><span class="thread__meta"><span class="thread__title">${esc(title)}</span><span class="thread__preview">${esc(prev||'No description')}</span></span><span class="thread__time">${esc(when)}</span></button></li>`;
  }).join(''));
}
function reqDetail(req){
  const rows=[
    ['Created',new Date(req.createdAt).toLocaleString()],
    ['Location',[req.location.city,req.location.county].filter(Boolean).join(', ')||'—'],
    ['Car',[req.car.make,req.car.model,req.car.year].filter(Boolean).join(' ')||'—'],
    ['Category',req.category||'—'],
    ['Urgency',req.urgency||'—'],
    ['Contact',req.contact||'—'],
    ['Phone',req.phone||'—']
  ];
  const dl=rows.map(([k,v])=>`<div><dt>${esc(k)}</dt><dd>${esc(String(v||'—'))}</dd></div>`).join('');
  const desc=req.description?`<p><strong>Description</strong></p><p>${esc(req.description)}</p>`:'<p>No description.</p>';
  return `<section class="panel" aria-label="Request summary"><dl class="metrics" aria-label="Request fields">${dl}</dl>${desc}</section>`;
}
function reqText(req){
  return [
    `Request ID: ${req.id}`,
    `Created: ${new Date(req.createdAt).toLocaleString()}`,
    `Location: ${[req.location.city,req.location.county].filter(Boolean).join(', ')}`,
    `Car: ${[req.car.make,req.car.model,req.car.year].filter(Boolean).join(' ')}`,
    `Category: ${req.category||''}`,
    `Urgency: ${req.urgency||''}`,
    `Contact: ${req.contact||''}`,
    `Phone: ${req.phone||''}`,
    `Description: ${req.description||''}`
  ].filter(Boolean).join('\n');
}
function openReq(id,trigger){
  const req=(requests||[]).find(r=>r.id===id);
  if(!req)return toast('Request not found');
  ui.lastSelected=id;saveUI();
  const x=ensureRequestDlg();
  const slot=x.querySelector('[data-bind="requestDetail"]');
  if(slot)slot.innerHTML=reqDetail(req);
  openDialog('request-detail',trigger);
}
async function copySelReq(){
  const id=ui.lastSelected;
  const req=(requests||[]).find(r=>r.id===id);
  if(!req)return toast('Nothing to copy');
  toast((await copyText(reqText(req)))?'Copied request':'Copy failed');
}

/* ---------- Events (delegated) ---------- */
function onClick(e){
  const el=e.target.closest('[data-action],[data-route]');
  if(!el)return;
  if(el.dataset.route){e.preventDefault();return navigate(el.dataset.route);}
  const a=el.dataset.action;
  if(a==='toggle-theme')return toggleTheme();
  if(a==='dismiss-toast')return dismissToast();
  if(a==='open-dialog')return openDialog(el.dataset.dialog,el);
  if(a==='close-dialog')return closeDialog(el.dataset.dialog);
  if(a==='step-next')return stepNext();
  if(a==='step-back')return stepBack();
  if(a==='copy-number'){const num=el.dataset.number||'';return copyText(num).then(ok=>toast(ok?'Copied number':'Copy failed'));}
  if(a==='open-request')return openReq(el.dataset.requestId,el);
  if(a==='copy-request')return copySelReq();
}
function onSubmit(e){
  const form=reqForm();
  if(!form||e.target!==form)return;
  e.preventDefault();
  clearErrs(form);
  const reg=ensureErr(form),errs=validateSection(form,form);
  if(errs.length){
    reg.hidden=false;
    reg.textContent=`Please fix ${errs.length} field${errs.length===1?'':'s'} before submitting.`;
    errs[0].f.focus({preventScroll:false});
    return;
  }
  const req=collectReq(form);
  requests.push(req);
  saveRequests();
  lastMatch={requestId:req.id,mechanics:match(req)};
  renderResults(lastMatch.mechanics);
  toast('Request received');
  navigate('results');
  try{form.reset();}catch{}
  resetStepper();
}
function onKeydown(e){
  if(e.key==='Escape'&&activeDlg){e.preventDefault();closeDialog();return;}
  trap(e);
}

/* ---------- Init ---------- */
function init(){
  setTheme(ui.theme);
  initStepper();
  d.addEventListener('click',onClick,{passive:false});
  d.addEventListener('submit',onSubmit,{passive:false});
  d.addEventListener('keydown',onKeydown,{passive:false});
  window.addEventListener('hashchange',()=>showRoute(getRoute()));
  tryLoadMechanics().finally(()=>{
    if(!location.hash)location.hash='#'+(ui.lastRoute||'home');
    showRoute(getRoute());
    renderInbox();
  });
}
if(d.readyState==='loading')d.addEventListener('DOMContentLoaded',init,{once:true});else init();
})();`
